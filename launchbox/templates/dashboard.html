{% extends "base.html" %}

{% block content %}
<div class="bg-white shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">
            <i class="fas fa-rocket text-blue-600 mr-3"></i>Launchbox Dashboard
        </h1>
        
        <!-- System Status -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-6 rounded-lg text-white">
                <div class="flex items-center">
                    <i class="fas fa-cube text-2xl mr-4"></i>
                    <div>
                        <h3 class="text-lg font-semibold">Applications</h3>
                        <p class="text-2xl font-bold">{{ apps|length }}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-gradient-to-r from-green-500 to-green-600 p-6 rounded-lg text-white">
                <div class="flex items-center">
                    <i class="fas fa-play text-2xl mr-4"></i>
                    <div>
                        <h3 class="text-lg font-semibold">Running</h3>
                        <p class="text-2xl font-bold">{{ apps|selectattr("status", "equalto", "running")|list|length }}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 p-6 rounded-lg text-white">
                <div class="flex items-center">
                    <i class="fas fa-docker text-2xl mr-4"></i>
                    <div>
                        <h3 class="text-lg font-semibold">Docker Status</h3>
                        <p class="text-lg font-semibold">{{ 'Connected' if docker_info else 'Disconnected' }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Applications Table -->
        <div class="bg-white shadow overflow-hidden sm:rounded-md">
            <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
                <h2 class="text-lg leading-6 font-medium text-gray-900">Applications</h2>
                <button onclick="refreshApps()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
            </div>
            <ul class="divide-y divide-gray-200" id="apps-list">
                {% for app in apps %}
                <li class="px-4 py-4 hover:bg-gray-50">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                {% if app.status == 'running' %}
                                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                {% elif app.status == 'exited' %}
                                    <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                {% elif app.status == 'not deployed' %}
                                    <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                                {% else %}
                                    <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                {% endif %}
                            </div>
                            <div class="ml-4">
                                <div class="flex items-center">
                                    <h3 class="text-sm font-medium text-gray-900">{{ app.name }}</h3>
                                    {% if app.has_config %}
                                        <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            <i class="fas fa-cog mr-1"></i>Configured
                                        </span>
                                    {% endif %}
                                    {% if not app.has_dockerfile %}
                                        <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                            <i class="fas fa-exclamation-triangle mr-1"></i>No Dockerfile
                                        </span>
                                    {% endif %}
                                </div>
                                <div class="mt-1 flex items-center text-sm text-gray-500">
                                    <span>Status: {{ app.status|title }}</span>
                                    <span class="mx-2">•</span>
                                    <span>Port: {{ app.port }}</span>
                                    {% if app.container_id %}
                                        <span class="mx-2">•</span>
                                        <span>Container: {{ app.container_id }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            {% if app.status == 'running' %}
                                <a href="{{ app.url }}" target="_blank" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-external-link-alt mr-1"></i>Visit
                                </a>
                                <button onclick="stopApp('{{ app.name }}')" class="text-red-600 hover:text-red-800 font-medium">
                                    <i class="fas fa-stop mr-1"></i>Stop
                                </button>
                            {% elif app.status == 'exited' %}
                                <button onclick="startApp('{{ app.name }}')" class="text-green-600 hover:text-green-800 font-medium">
                                    <i class="fas fa-play mr-1"></i>Start
                                </button>
                            {% elif app.has_dockerfile %}
                                <button onclick="deployApp('{{ app.name }}')" class="text-green-600 hover:text-green-800 font-medium">
                                    <i class="fas fa-rocket mr-1"></i>Deploy
                                </button>
                            {% endif %}
                            
                            {% if app.status != 'not deployed' %}
                                <button onclick="showLogs('{{ app.name }}')" class="text-blue-600 hover:text-blue-800 font-medium">
                                    <i class="fas fa-file-alt mr-1"></i>Logs
                                </button>
                            {% endif %}
                            
                            <a href="/app/{{ app.name }}" class="text-gray-600 hover:text-gray-800 font-medium">
                                <i class="fas fa-info-circle mr-1"></i>Details
                            </a>
                        </div>
                    </div>
                </li>
                {% else %}
                <li class="px-4 py-8 text-center text-gray-500">
                    <i class="fas fa-inbox text-4xl mb-4"></i>
                    <p>No applications found. Create an app in the <code>apps/</code> directory to get started.</p>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<!-- Logs Modal -->
<div id="logsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden" style="z-index: 1000;">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900" id="logsTitle">Application Logs</h3>
                <button onclick="closeLogs()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm overflow-auto max-h-96" id="logsContent">
                <!-- Logs will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
    async function deployApp(appName) {
        const button = event.target;
        const originalText = button.innerHTML;
        showLoading(button);
        
        try {
            const response = await axios.post(`/api/apps/${appName}/deploy`);
            showNotification(`Successfully deployed ${appName}`, 'success');
            setTimeout(() => window.location.reload(), 2000);
        } catch (error) {
            const message = error.response?.data?.error || `Failed to deploy ${appName}`;
            showNotification(message, 'error');
        } finally {
            hideLoading(button, originalText);
        }
    }

    async function stopApp(appName) {
        const button = event.target;
        const originalText = button.innerHTML;
        showLoading(button);
        
        try {
            const response = await axios.post(`/api/apps/${appName}/stop`);
            showNotification(`Successfully stopped ${appName}`, 'success');
            setTimeout(() => window.location.reload(), 1000);
        } catch (error) {
            const message = error.response?.data?.error || `Failed to stop ${appName}`;
            showNotification(message, 'error');
        } finally {
            hideLoading(button, originalText);
        }
    }

    async function startApp(appName) {
        const button = event.target;
        const originalText = button.innerHTML;
        showLoading(button);
        
        try {
            const response = await axios.post(`/api/apps/${appName}/start`);
            showNotification(`Successfully started ${appName}`, 'success');
            setTimeout(() => window.location.reload(), 1000);
        } catch (error) {
            const message = error.response?.data?.error || `Failed to start ${appName}`;
            showNotification(message, 'error');
        } finally {
            hideLoading(button, originalText);
        }
    }

    async function showLogs(appName) {
        try {
            const response = await axios.get(`/api/apps/${appName}/logs`);
            document.getElementById('logsTitle').textContent = `${appName} - Logs`;
            document.getElementById('logsContent').textContent = response.data.logs || 'No logs available';
            document.getElementById('logsModal').classList.remove('hidden');
        } catch (error) {
            const message = error.response?.data?.error || `Failed to fetch logs for ${appName}`;
            showNotification(message, 'error');
        }
    }

    function closeLogs() {
        document.getElementById('logsModal').classList.add('hidden');
    }

    function refreshApps() {
        window.location.reload();
    }

    // Close modal when clicking outside
    document.getElementById('logsModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeLogs();
        }
    });
</script>
{% endblock %}